name: Run tests and send SMS

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  test-and-sms:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Run tests
      id: tests
      run: |
        set +e
        python test.py > test_output.txt 2>&1
        EXIT_CODE=$?
        echo "exit_code=${EXIT_CODE}" >> $GITHUB_OUTPUT
        set -e

    - name: Compose SMS message
      run: |
        echo "Tests finished on $GITHUB_REPOSITORY (exit ${{ steps.tests.outputs.exit_code }})" > sms.txt

    - name: Send SMS via system sendmail
      run: |
        /usr/sbin/sendmail 8607728594@txt.att.net < sms.txt
